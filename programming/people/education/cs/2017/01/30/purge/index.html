<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Purge cache after Jekyll build using Travis CI – Hannan's fascinations</title>
<link rel="dns-prefetch" href="//maxcdn.bootstrapcdn.com">
<link rel="dns-prefetch" href="//cdn.mathjax.org">
<link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="description" content="Purging Cache using Cloudflare after building Jekyll saves me from purging everything, and not buy the tag feature">
<meta name="robots" content="all">
<meta name="author" content="Hannan Ali">
<meta name="keywords" content="programming, people, education, CS">
<link rel="canonical" href="https://fascinations.hannanali.tech/programming/people/education/cs/2017/01/30/purge/">
<link rel="alternate" type="application/rss+xml" title="RSS Feed for Hannan's fascinations" href="/feed.xml">
<link rel="stylesheet" href="/css/pixyll.css?201702030917" type="text/css">
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fluidbox/2.0.4/css/fluidbox.min.css">
<link href="//fonts.googleapis.com/css?family=Merriweather:900,900italic,300,300italic" rel="stylesheet" type="text/css">
<link href="//fonts.googleapis.com/css?family=Lato:900,300" rel="stylesheet" type="text/css">
<link href="//maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
<meta property="fb:app_id" content="239215849863182">
<meta name="google-site-verification" content="AxhZ9PEqDwclQ827jKqeYjZ2dDOdOU6NabKYmIcicvU">
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Purge cache after Jekyll build using Travis CI">
<meta property="og:description" content="Purging Cache using Cloudflare after building Jekyll saves me from purging everything, and not buy the tag feature">
<meta property="og:url" content="https://fascinations.hannanali.tech/programming/people/education/cs/2017/01/30/purge/">
<meta property="og:site_name" content="Hannan's fascinations">
<meta property="og:author" content="Hannan Ali">
<meta property="og:image" content="https://www.cloudflare.com/img/logo-cloudflare-dark.svg">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@computistic">
<meta name="twitter:title" content="Purge cache after Jekyll build using Travis CI">
<meta name="twitter:description" content="Purging Cache using Cloudflare after building Jekyll saves me from purging everything, and not buy the tag feature">
<meta name="twitter:url" content="https://fascinations.hannanali.tech/programming/people/education/cs/2017/01/30/purge/">
<link rel="apple-touch-icon" sizes="57x57" href="/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="114x114" href="/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="72x72" href="/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="144x144" href="/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="60x60" href="/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="120x120" href="/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="76x76" href="/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="152x152" href="/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicon-160x160.png" sizes="160x160">
<link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"> <script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-78074618-6","auto"),ga("send","pageview")</script>
</head>
<body class="site animated fade-in-down">
<div id="fb-root"></div> <script>!function(e,n,t){var o,c=e.getElementsByTagName(n)[0];e.getElementById(t)||(o=e.createElement(n),o.id=t,o.src="//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.5&appId=239215849863182",c.parentNode.insertBefore(o,c))}(document,"script","facebook-jssdk")</script><div class="site-wrap"> <header class="site-header px2 px-responsive"><div class="mt2 wrap"><div class="measure"> <a href="https://fascinations.hannanali.tech" class="site-title">Hannan's fascinations</a> <nav class="site-nav"> <a href="/about/">About Hannan</a><a href="http://tinyletter.com/computistic">Sign up for newsletter!</a></nav><div class="clearfix"></div>
<div class="social-icons">
<div class="social-icons-right"> <a class="fa fa-github" href="https://github.com/abdulhannanali"></a> <a class="fa fa-rss" href="/feed.xml"></a> <a class="fa fa-twitter" href="https://twitter.com/computistic"></a> <a class="fa fa-envelope" href="mailto:ali.abdulhannan@gmail.com"></a> <a class="fa fa-linkedin" href="https://www.linkedin.com/in/hannanali"></a> <a class="fa fa-medium" href="https://medium.com/@computistic"></a>
</div>
<div class="right"></div>
</div>
<div class="clearfix"></div>
</div></div> </header><div class="post p2 p-responsive wrap" role="main"><div class="measure">
<div class="post-header mb2">
<h1>Purge cache after Jekyll build using Travis CI</h1> <span class="post-meta">Jan 30, 2017</span><br> <span class="post-meta small"> 3 minute read </span>
</div>
<div class="post-edit-link"> <a href="https://github.com/abdulhannanali/fascinations-of-hannan/edit/master/_posts/2017-01-30-purge.md"> <i class="fa fa-pencil-square-o"></i> Edit on Github <i class="fa fa-github"></i> </a>
</div>
<article class="post-content"><p class="center lightbox"><a href="https://www.cloudflare.com/img/logo-cloudflare-dark.svg"> <img src="https://www.cloudflare.com/img/logo-cloudflare-dark.svg" alt="Cloudflare Logo" width="360px" heigh="240px"> </a></p>
<p>I use <a href="https://www.cloudflare.com/cdn/">Cloudflare’s CDN</a> for this site, as it’s very easy to setup and also has a free plan, which is just right for my usage, as I want to deliver this site as fast as possible to the users, and it reduces my actual bandwidth usage on <a href="https://firebase.com">Firebase</a> which is quite limited on the Free Tier <strong>(10 GB/Month)</strong></p>
<p>A usecase occured where I was publishing major changes to my jekyll blog very frequently, Cloudflare’s CDN wasn’t getting revalidated each time, I did a <code class="highlighter-rouge">jekyll build</code> using <code class="highlighter-rouge">TravisCI</code> which was leading to inconsidtent user experience as the content previously cached on the CDN wasn’t getting invalidated.</p>
<h2 id="cloudflares-purging-options">Cloudflare’s Purging Options</h2>
<p>Luckily Cloudflare offers, nice options to purge the content from the CDN. Cloudflare offers <a href="https://support.cloudflare.com/hc/en-us/articles/200169246-How-do-I-purge-my-cache-">various options</a> in order to purge the cache.</p>
<p>On a free plan, I could’ve either purged the entire cache, or purge individual files by url.</p>
<p>Purging entire cache was never an option, as I not only use this domain for my Blog, but also for Github Pages, Portfolio, and some other random things, I don’t even remember about right now.</p>
<p>After considering the two options, I went for Purging by Individual files, however, doing it all through the UI, every single time, would be quite hard for me to do.</p>
<h2 id="cloudflare-api-and-nodejs-client">Cloudflare API and Node.js Client</h2>
<p><a href="https://api.cloudflare.com/">Cloudflare API</a> exposes the entire interface of Cloudflare, including Purging. In order to purge files individually, we can pass it an array of file URLs <em>(upto 30 in a request)</em>.</p>
<p>Cloudflare also has an easy to use <a href="https://www.npmjs.com/package/cloudflare">node.js client</a>, which I used to do something cool, we are going to talk about next.</p>
<h2 id="writing-a-script-to-purge-using-cloudfares-nodejs-client">Writing a script to purge using Cloudfare’s Node.js client</h2>
<p>Afterwards, I just wrote a simple script that parsed the URLs present in the <code class="highlighter-rouge">sitemap.xml</code> of build folder <code class="highlighter-rouge">(_site)</code> using node library <code class="highlighter-rouge">xml2js</code>. Cloudflare had a limit of upto 30 URLs that can be purged in one request <em>(which might be there to protect from misuse)</em> , in order to solve this problem, we returned multiple promisified calls to <code class="highlighter-rouge">Zone.deleteCache</code> of URLs chunked into array at max 30 urls and resolved them all using <code class="highlighter-rouge">Promise.all</code> function.</p>
<p>You can take a look at the scripts I wrote for purging by going to <a href="https://github.com/abdulhannanali/fascinations-of-hannan/tree/master/scripts/purger">scripts/purger</a> directory in this blog’s repository. <a href="https://github.com/abdulhannanali/fascinations-of-hannan/blob/master/scripts/purger/index.js">purger/index.js</a> is the main file initiated to purge the URLs from Cloudflare.</p>
<h3 id="automating-script-purging-task-using-traviscihttpstravis-ciorg">Automating script purging task using <a href="https://travis-ci.org">TravisCI</a>
</h3>
<p class="lightbox"><a href="https://cdn.travis-ci.org/images/logos/TravisCI-Mascot-1-20feeadb48fc2492ba741d89cb5a5c8a.png"> <img src="https://cdn.travis-ci.org/images/logos/TravisCI-Mascot-1-20feeadb48fc2492ba741d89cb5a5c8a.png" width="140px" height="140px" style="float:left;margin:10px"> </a></p>
<p>Doing a build and deploying it to two environments production and staging, none of these tasks are handled by me, but by <a href="https://travis-ci.org"><strong>Travis the builder</strong></a>. This is quite a mundane task, and will save hours in the long run if properly automated.</p>
<p>After the deploy is succeeded to the <code class="highlighter-rouge">master</code> branch successfully, <code class="highlighter-rouge">scripts/purger/index.js</code> is initiated using this simple command</p>
<div class="language-bash highlighter-rouge"><pre class="highlight"><code>node --harmony_async_await scripts/purger/index.js
</code></pre></div>
<blockquote><p><em>Note: <code class="highlighter-rouge">--harmony_async_await</code> flag is only there as <code class="highlighter-rouge">async/await</code> is not a stable feature in Node.js as of <code class="highlighter-rouge">v7.4.0</code>, refrain from using it in server side production code, right now</em></p></blockquote>
<p>This purge task needs to be run only in <code class="highlighter-rouge">master</code>, as I don’t have Cloudflare CDN set up for the domains running in staging environment, such as “surge.sh”, and “Github Pages”, so we run this command after the deploy to firebase succeeds within the <code class="highlighter-rouge">"TRAVIS_BRANCH" == "master"</code> condition in <code class="highlighter-rouge">deploy.sh</code>.</p>
<h4 id="power-of-travisci-and-cloudflare">Power of TravisCI and Cloudflare</h4>
<p>Here’s to show the power of what you can achieve using Cloudflare’s Powerful API and the customization Travis CI provides you in your build environment.</p>
<p>I hope you learned about extent to which you can customize and control your Jekyll build environment, through tools such as <a href="https://travis-ci.org">TravisCI</a> and also discover how easy it is to use Cloudflare’s API to do tasks, that might take a lot of time otherwise, if done manually from the Cloudflare’s UI. <img class="emoji" title=":heart:" alt=":heart:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2764.png" height="20" width="20" align="absmiddle"></p>
<blockquote class="blue"><p>If you found this post helpful, please give it a Like <img class="emoji" title=":thumbsup:" alt=":thumbsup:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f44d.png" height="20" width="20" align="absmiddle"> . I am looking forward to hear what you have to say on this topic, do post a comment below. <img class="emoji" title=":heart:" alt=":heart:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/2764.png" height="20" width="20" align="absmiddle"> <img class="emoji" title=":tada:" alt=":tada:" src="https://assets-cdn.github.com/images/icons/emoji/unicode/1f389.png" height="20" width="20" align="absmiddle"></p></blockquote></article><div class="fb-like" data-href="https://fascinations.hannanali.tech/programming/people/education/cs/2017/01/30/purge/" data-layout="standard" data-action="like" data-size="large" data-show-faces="true" data-share="false"></div>
<div class="share-page"> <br> Spread the word!<div class="share-links"> <a class="fa fa-facebook" href="https://facebook.com/sharer.php?u=https://fascinations.hannanali.tech/programming/people/education/cs/2017/01/30/purge/" rel="nofollow" target="_blank" title="Spread on Facebook"></a> <a class="fa fa-twitter" href="https://twitter.com/intent/tweet?text=Purge%20cache%20after%20Jekyll%20build%20using%20Travis%20CI&amp;url=https://fascinations.hannanali.tech/programming/people/education/cs/2017/01/30/purge/" rel="nofollow" target="_blank" title="Spread on Twitter"></a> <a class="fa fa-linkedin" href="http://www.linkedin.com/shareArticle?url=https://fascinations.hannanali.tech/programming/people/education/cs/2017/01/30/purge/&amp;title=Purge%20cache%20after%20Jekyll%20build%20using%20Travis%20CI" rel="nofollow" target="_blank" title="Spread on LinkedIn"></a> <a class="fa fa-hacker-news" onclick="parent.postMessage('submit','*')" href="https://news.ycombinator.com/submitlink?u=https://fascinations.hannanali.tech/programming/people/education/cs/2017/01/30/purge/&amp;t=Purge%20cache%20after%20Jekyll%20build%20using%20Travis%20CI" rel="nofollow" target="_blank" title="Spread on Hacker News"></a>
</div> <br>
</div>
<h3 class="related-post-title">Related Posts</h3>
<div class="post ml2"> <a href="/programming/people/education/cs/2017/01/27/Code-index/" class="post-link"><h4 class="post-title">Improving lives through CS and coding</h4>
<p class="post-summary">This post highlights the importance of Computer Science Education and how we can do more to get more people to code, create cool things and be ready for the exciting future.</p> </a>
</div>
<div class="post ml2"> <a href="/travis/ci/technology/2017/01/26/travis-ci-index/" class="post-link"><h4 class="post-title">Setting up Travis CI for Jekyll to build and deploy</h4>
<p class="post-summary">I write about my experience with TravisCI and my first TravisCI file</p> </a>
</div>
<div class="fb-comments" data-href="https://fascinations.hannanali.tech/programming/people/education/cs/2017/01/30/purge/" data-width="100%" data-numposts="10"></div>
<div class="fb-quote"></div>
</div></div>
</div>
<footer class="center"><div class="measure"> This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. Feel free to reuse anything but do provide the attribution. Things I write here are my thoughts, and I don't enforce them on anyone.</div> </footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fluidbox/2.0.4/js/jquery.fluidbox.min.js"></script><script>$(document).ready(function(){var i=function(){var i=!1;return function(a){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))&&(i=!0)}(navigator.userAgent||navigator.vendor||window.opera),i}();i||$(".lightbox a").fluidbox()})</script>
</body>
</html>
